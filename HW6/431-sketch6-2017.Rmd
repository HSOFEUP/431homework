---
title: "Assignment 6 Answer Sketch"
author: "431 staff"
date: "due 2017-12-04 at noon"
output:
  pdf_document:
    toc: yes
---

## Grading: Questions 2, 3, 4 and 5 are graded, for a total possible 70 points.

## R Setup

```{r setup, message=FALSE}
knitr::opts_chunk$set(comment=NA)
options(width = 75)

library(forcats); library(pander); library(car) 
library(gridExtra); library(tidyverse)

plasma <- read.csv("hw6plasma.csv") %>% tbl_df

plasma$sex <- fct_recode(as.character(plasma$sex), "Female" = "2", "Male" = "1")

plasma$smoking <- fct_recode(as.character(plasma$smoking), 
               "never" = "1", "former" = "2", "current" = "3")
```

\newpage

# Question 1 (optional - graded as Yes or No)

\color{blue}*Find a Wikipedia page with a table that interests you. Scrape the data from the table and clean it up, converting character strings to numbers, dropping unneeded variables, and so forth, leading to a tidy data set in R. Create a statistical graph from these data. Write a caption for your figure that interprets your findings. Be sure to provide the link to the original Wikipedia table.*\color{black}

We didn't write a sketch for this question. 

Students got a Yes if [a] they addressed the specified tasks in an easy-to-follow manner, [b] their Wikipedia page was linked properly, [c] they wrote an appropriate caption and [d] they produced a reasonable graph [e] from a tidy data set. If most, but not quite all of those things were true, we still marked Yes, but a substantial effort towards each piece was required. Otherwise, it's a No.

# Question 2 (30 points)

\color{blue}*Find an example of a visualization designed to support a linear regression analysis in a published work (online or not) for which you can find the complete sourcing information, and which was built no earlier than January 1, 2014. Provide the complete reference and a copy of the image itself (including any captions or titles) and surrounding material for the visualization, and provide a brief essay (likely to run 150-250 words) which accomplishes each of the following tasks:*\color{black}

- \color{blue}*Describe the linear regression model behind the visualization. Explain its context and why it is important. Specify the research question that this regression model answers.*\color{black}
- \color{blue}*Describe the visualization and explain what you believe it is trying to do. Specify why it is or is not effective, in your view.*\color{black}
- \color{blue}*Provide your best suggestion as to how the visualization might be improved, and explain why your change would be an improvement.*\color{black}

We didn't write a sketch for this question. 

\newpage

# Question 3 (15 points)

\color{blue}*In questions 3-6, you will build and present an appropriate model for plasma retinol levels. Use only the **275 observations** where `holdout` is 0 for Questions 3-9.*\color{black}

```{r development_sample}
plasma_dev <- 
    plasma %>% 
    filter(holdout == 0)
```

a. \color{blue}*Specify whether a transformation of the outcome is necessary, and how you know. If you need a transformation, specify a wise choice.*\color{black}

I had intended that you would first build the necessary regression model and use the Box-Cox procedure to identify potential outcome transformations...

```{r Q3 model1 box cox, fig.height = 4}
ret.m1 <- lm(retplasma ~ age + sex + factor(smoking) + bmi 
              + factor(vitamin) + calories + fat + fiber 
              + alcohol + cholesterol + retdiet, data = plasma_dev)

boxCox(ret.m1)
powerTransform(ret.m1)
```

This approach suggests using the logarithm of `retplasma` as our outcome. Here is that model.

```{r Q3 model2}
ret.m2 <- lm(log(retplasma) ~ age + sex + factor(smoking) + bmi 
              + factor(vitamin) + calories + fat + fiber 
              + alcohol + cholesterol + retdiet, data = plasma_dev)
```

Now, we can compare the residual plots generated by these two models.

```{r plots of residuals for model 1, fig.height = 3}
par(mfrow = c(1,2))
plot(ret.m1, which = 1:2)
par(mfrow = c(1,1))
```

and then, after transforming the outcome (`retplasma`) using the logarithm, we have the following residual plots.

```{r plots of residuals for model 2, fig.height = 3}
par(mfrow = c(1,2))
plot(ret.m2, which = 1:2)
par(mfrow = c(1,1))
```

In my mind, the logarithm is better, in that we have a better balance above and below the zero line on the left plot (residuals vs. fitted plot) and a somewhat better Normal Q-Q plot, especially at the top end of the distribution. But you could probably go either way here. I'll show the remaining results with the log transformation for the outcome.

b. \color{blue}*Select predictors from the demographic, behavioral and relevant dietary factors described in the data (i.e. not including `id`, `betadiet`, `betaplasma` or `holdout`.)*\color{black}


We'll start with our "kitchen sink" model.

```{r Q4 kitchen sink}
ret.m2 <- lm(log(retplasma) ~ age + sex + factor(smoking) + bmi 
              + factor(vitamin) + calories + fat + fiber 
              + alcohol + cholesterol + retdiet, data = plasma_dev)
summary(ret.m2)
```

Next, we'll use a stepwise algorithm to identify a set of predictors worthy of further study.

```{r Q4 stepwise}

ret.m3 <- step(ret.m2)

pander(summary(ret.m3), caption = "Summary of Stepwise model", digits = 3)

```


c. \color{blue}*Motivate your choice of predictors, including an assessment of the impact of collinearity, with appropriate accounting for it in your final choice of model. Specify and demonstrate the impact of your model selection algorithm.*\color{black}

I used a stepwise algorithm (backwards elimination) to obtain the models above. In each case, I can identify possible collinearity issues using the variance inflation factor.

```{r Q5}

car::vif(ret.m3)

```

Note that this version of the `vif` function, obtained through the `car` library, calculates a generalized variance inflation factor. We see no signs of substantial collinearity here.

\newpage

# Question 4 (15 points, 5 points for each part)

a. \color{blue}*Summarize the findings in a clear presentation of your final model, including a short recap of the steps you took to produce it.*\color{black}

Here, I was looking for a detailed statement of the model, indicating its overall significance, the R-squared value and the directions of the coefficients in the model. In the holdout sample, we might conclude that the combination of age, smoking status and fiber, together explained just over 9% of the variation in plasma retinol, and that this model had statistically significant predictive value. We would then indicate that retinol was associated with increasing age, being a former smoker (as opposed to a current or never smoker), while it is also associated with decreasing fiber consumption. We might even have standardized the coefficients to look at the relative size of each predictor's impact on the predictions.


b. \color{blue}*Demonstrate the utility of the final model, including summaries based on $R^2$ and significance testing.*\color{black}

The R-squared for this model is `r round(summary(ret.m3)$r.squared,3)` meaning that the model accounts for `r round(100*summary(ret.m3)$r.squared,1)`% of the variation in plasma concentration of retinol.

The adjusted R-squared for the model is `r round(summary(ret.m3)$adj.r.squared,3)` which indicates no severe issues with overfitting.

In terms of significance testing, we have the following t test results:

```{r Q6}

pander(summary(ret.m3))

```

c. \color{blue}*Demonstrate that your final model passes required checks of assumptions.*\color{black}

A set of diagnostic model plots will inform the answer to this question: 

```{r q7, fig.height = 6}

par(mfrow = c(2, 2))

plot(ret.m3)

par(mfrow = c(1,1))

```

There are no signs of very serious trouble here with the assumptions of linearity, normality (maybe a few outliers on the low end of the residual distribution), homoscedasticity, and independence isn't really an issue here.

# Question 5 (10 points)

\color{blue}*In a single sentence, outline the key findings for plasma retinol specified by your model.*\color{black}

This would be a shorter description - a subset of the previous answer would do - something like: Retinol was associated with increasing age and being a former smoker, while it is also associated with decreasing fiber consumption. 

# Question 6 (optional - graded as Yes or No)

\color{blue}*At this point, we will return to working with the whole set of 300 observations. Validate your choice of model for plasma retinol level by using your final choice developed in questions 3-9 to predict data for the 25 cases that you have withheld from the data, comparing your final model to these two other models:*

- *A model using `age` and `sex` alone.*
- *A model that uses the entire set (kitchen sink) of possible predictors, i.e. everything but `id`, `betadiet` and `betaplasma`.*

*Which model looks best in your comparison? Justify your response.*\color{black}

Our goal now is to compare the predictions made by our final choice of model for plasma retinol established in Question 5 above to those of a model with age and sex only, and to the model with all available predictors using our holdout sample of 25 observations, and using both mean absolute prediction error and mean squared prediction error to develop our conclusions.

Our three models are

```{r Q10 three models}

model1 <- lm(log(retplasma) ~ age + sex, data=plasma_dev)

model2 <- ret.m3

model3 <- lm(log(retplasma) ~ age + sex + factor(smoking) + bmi 
              + factor(vitamin) + calories + fat + fiber 
              + alcohol + cholesterol + retdiet, data=plasma_dev)

anova(model1, model2, model3)

```

The ANOVA suggests that dropping from model 3 to model 2 here is not causing a statistically significant lack of fit, but that moving from model 2 down to model 1 might be (we can't be sure because Model 1 is not a subset of Model 2.

Now, we'll predict the values of `retplasma` in the holdout sample using each of the three models in turn, then compare the errors made, and calculate the absolute errors and squared errors for each prediction. Since our models predict the log of our outcome, we will exponentiate the predictions to get back on the original `retplasma` scale.

```{r Q7 predictions and errors}

plasma_test <- plasma %>% filter(holdout == 1)

model1.pre <- exp(predict(model1, newdata=plasma_test))
model2.pre <- exp(predict(model2, newdata=plasma_test))
model3.pre <- exp(predict(model3, newdata=plasma_test))

model1.err <- plasma_test$retplasma - model1.pre
model2.err <- plasma_test$retplasma - model2.pre
model3.err <- plasma_test$retplasma - model3.pre

model1.abserr <- abs(model1.err)
model2.abserr <- abs(model2.err)
model3.abserr <- abs(model3.err)

model1.sqerr <- model1.err^2
model2.sqerr <- model2.err^2
model3.sqerr <- model3.err^2

```

Now, we summarize the prediction errors in the holdout sample for predicting retinol plasma concentrations. 

Model | MAPE | MSPE 
-----: | ----: | ----:
1 (age + sex) | `r round(mean(model1.abserr),1)` | `r sprintf("%0.0f", mean(model1.sqerr))`
2 (our model) | `r round(mean(model2.abserr),1)` | `r sprintf("%0.0f", mean(model2.sqerr))`
3 (kitchen sink) | `r round(mean(model3.abserr),1)` | `r sprintf("%0.0f", mean(model3.sqerr))`

Looking at the mean absolute prediction error (MAPE) and the mean squared prediction error (MSPE), it appears that the `age + sex` model is superior to the competitors in this test sample. 